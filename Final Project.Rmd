---
title: "Final Project"
output: pdf_document
authors: Leyla Akay and Maryann Zhao
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, fig.height=3, fig.width=5, fig.align = "center")
library(dplyr)
library(ggplot2)
library(infer)
library(skimr)
library(broom)
library(mosaic)
library(knitr)
library(readr)
library(graphics)
library(GGally)
require(lattice)
library(readr)
library(purrr)
require(glmnet)
library(FactoMineR)
library(plot3D)
options(digits=3)
```

```{r, include=FALSE}
movies <- read_csv("~/LM HW/SLM_Project/tmdb_2.csv")

#code english into 1 and else 0
lang <- c()
for (i in 1:4803){
 lang[i]<- ifelse(movies$original_language[i] == "en", 1, 0)
}
  
#dates after the year 2007
dates <- as.Date(movies$release_date, "%m/%d/%y")
dates <- as.numeric(substring(dates, 1, 4))
movies <- movies %>%
  mutate(years = dates) 
oh7 <- c()
for (i in 1:4803){
 oh7[i]<- ifelse(movies$years[i] >= 2007, 1, 0)
}


#check first 2 genres to see if they are action, adventure or drama based on most popular genres (website)
action <- c()
adv <- c()
drama <- c()
for (i in 1:4803){
 action[i] <- ifelse(movies$genres1[i] == "Action" | movies$genres2[i] == "Action", 1, 0)
 action[i] <- ifelse(is.nan(action[i]) | is.na(action[i]), 0, action[i])
 adv[i] <- ifelse(movies$genres1[i] == "Adventure" | movies$genres2[i] == "Adventure", 1, 0)
 adv[i] <- ifelse(is.nan(adv[i]) | is.na(adv[i]), 0, adv[i])
 drama[i] <- ifelse(movies$genres1[i] == "Drama" | movies$genres2[i] == "Drama", 1, 0)
 drama[i] <- ifelse(is.nan(drama[i]) | is.na(drama[i]), 0, drama[i])
}
movies <- movies %>%
  mutate(oh7 = oh7, action = action, adv = adv, drama = drama, lang = lang)

#Remove 0 values
movies.genre <-movies %>%
  select(popularity, budget, revenue, vote_average, vote_count, oh7, adv, action, drama, lang, genres1) %>%
  filter(budget > 0, revenue > 0, vote_count > 0)
movies.new <- movies %>%
  select(popularity, budget, revenue, vote_average, vote_count, oh7, adv, action, drama, lang, genres1) %>%
  filter(budget > 0, revenue > 0, vote_count > 0)

#logged variables
movies.log <- movies.new %>%
  mutate(pop.log = log(popularity), rev.log = log(revenue), bud.log = log(budget), count.log = log(vote_count), rev.bud.int = log(budget)*log(revenue))%>%
  select(pop.log, rev.log, vote_average, bud.log, count.log, oh7, adv, action, drama, lang, rev.bud.int, genres1)

#rename variables for function
test.new<- test %>%
  mutate(popularity = pop.log, revenue = rev.log, budget = bud.log, vote_count = count.log)%>%
  select(popularity, revenue, vote_average, budget, vote_count, oh7, adv, action, drama, lang)

#MLR
og.lm <- lm(log(popularity) ~ log(revenue) + vote_average + log(budget), data=movies.new)
full.lm <- lm(log(popularity) ~ log(revenue) + vote_average + log(budget) + vote_count + oh7  + action + adv+ drama + lang , data=movies.new)
int.lm <- lm(log(popularity) ~ log(revenue) + vote_average + log(budget) + log(vote_count) + oh7 + adv + action + drama + lang + log(revenue)*log(budget), data=movies.new)

anova(og.lm, full.lm)
anova(full.lm, int.lm)
anova(int.lm)
anova(full.lm)
tidy(int.lm)

pop.budget <- lm(log(popularity) ~ log(vote_count), data = movies.new)
ggplot(pop.budget, aes(x=fitted(pop.budget), y=resid(pop.budget))) + geom_point()

#LASSO 
set.seed(10)
lambda.grid =10^seq(5,-2, length =100)
sample <- sample.int(n = nrow(movies.log), size = floor(.90*nrow(movies.log)), replace = F)
train <- movies.log[sample, ]
test  <- movies.log[-sample, ]

movies.lasso.cv <- cv.glmnet(as.matrix(train[,2:11]), train$pop.log,alpha=1, lambda = lambda.grid, standardize=TRUE)
plot(movies.lasso.cv)+
  abline(v=log(movies.lasso.cv$lambda.min), col="green")
movies.lasso.cv$lambda.min

#LASSO model with min lambda
movies.lasso <- glmnet(as.matrix(train[,2:11]), train$pop.log,alpha=1, lambda = movies.lasso.cv$lambda.min, standardize=TRUE)
tidy(movies.lasso)

#plot lasso coefficients
colors <- rainbow(10)
movies.lasso <- glmnet(as.matrix(train[,2:11]), train$pop.log,alpha=1, lambda = lambda.grid, standardize=TRUE)
plot(movies.lasso, xvar="lambda", xlim=c(-6,10),col=colors)+
  abline(v=log(movies.lasso.cv$lambda.min))+
  abline(h=0, lty=2)+
  text(rep(-6.5, 10), coef(movies.lasso)[-1,length(lambda.grid)], colnames(train)[-1], pos=4, col=colors)

#ridge regression
movies.ridge.cv <- cv.glmnet(as.matrix(train[,2:11]), train$pop.log,alpha=0, lambda = lambda.grid, standardize=TRUE)
plot(movies.ridge.cv)+
  abline(v=log(movies.ridge.cv$lambda.min), col="green")
movies.ridge.cv$lambda.min

#RR with min lambda
movies.ridge <- glmnet(as.matrix(train[,2:11]), train$pop.log,alpha=0, lambda = movies.ridge.cv$lambda.min, standardize=TRUE)
tidy(movies.ridge)


#plot RR coefficients
movies.ridge <- glmnet(as.matrix(train[,2:11]), train$pop.log,alpha=0, lambda = lambda.grid, standardize=TRUE)
plot(movies.ridge, xvar="lambda", xlim=c(-6,10),col=colors)+
  abline(v=log(movies.ridge.cv$lambda.min))+
  abline(h=0, lty=2)+
  text(rep(-6.5, 9), coef(movies.ridge)[-1,length(lambda.grid)], colnames(train)[-1], pos=4, col=colors)

ridge.pred <- predict(movies.ridge.cv, newx = as.matrix(test[,2:11]),
s = "lambda.min")
lasso.pred <- predict(movies.lasso.cv, newx = as.matrix(test[,2:11]),
s = "lambda.min")
mlr.pred <- predict(int.lm, newdata = data.frame(test.new[,2:10]), type = "response")

#regression splines
require(splines)
count.knot6 <- bs(movies.log$count.log, df=6, degree=1)
count.rs <- lm(pop.log ~ count.knot6, data=movies.log)
summary(count.rs)

#plot regression splines
ggplot(movies.log, aes(count.log, pop.log)) +
  geom_point() +
  geom_smooth()
ggplot(movies.log, aes(count.log, pop.log)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ splines::bs(x, 3), se = FALSE, colour = "orange") +
  geom_smooth(method = "lm", formula = y ~ splines::bs(x, 5), se = FALSE, colour = "green") +
  geom_smooth(method = "lm", formula = y ~ splines::bs(x, 7), se = FALSE, colour = "purple") +
  geom_smooth(method = "lm", formula = y ~ splines::bs(x, 2), se = FALSE)
#qplot(count.log, pop.log, data=movies.log, geom=c("point", "smooth"), method = "lm", formula=y ~ ns(x, 6))
movies.log %>% ggplot(aes(count.log, pop.log)) + geom_point() + stat_smooth (method = "rlm")

#LOESS
count.lor <- loess(pop.log ~ count.log, span=.2, data=movies.log)

#PCA
library(ggfortify)
movies.cont<- movies.log %>%
  select(rev.log, vote_average, bud.log, count.log, genres1)
pca <- prcomp(movies.cont[1:4], scale. = T, center = TRUE)
autoplot(pca, loadings = TRUE, loadings.label = TRUE, loadings.label.size = 3, colours = 'genre1', data = movies.cont)
ggplot(pca, aes(x=PC1, y=PC2))+
  geom_point()

pca.data <- data.frame(pca$x, genre = movies.cont$genres1)

pca.data <- pca.data %>%
  mutate(genre2 = ifelse(genre %in% c( "Action", "Adventure", "Drama"), genre, "other"))

# plot of PCA
ggplot(pca.data,aes(x=PC1,y=PC2,col=genre2))+
   geom_point(size=2,alpha=0.5)+ #Size and alpha just for fun
   scale_color_manual(values = rainbow(4))+ #your colors here
   theme_classic()+
   ggtitle("PCA plot of Movies")

#logistic regression
library(caTools)
#lr1 <- glm ( ~ 1, data = movies.log, family = "binomial")
lr2 <- glm (action ~ pop.log+ rev.log + vote_average + bud.log + count.log + oh7 + lang, data = movies.log, family = "binomial")
anova(lr1, lr2, test="Chisq")
anova(lr2, test="Chisq")

ggplot(movies.log, aes(x=pop.log+ rev.log + vote_average + bud.log + count.log + oh7 + lang, y=action)) + geom_point() + 
  stat_smooth(method="glm", method.args = list(family="binomial"), se=FALSE)+
  xlim(0,120)

```

```{r}
#og model 
int.lm <- lm(log(popularity) ~ log(revenue) + vote_average + log(budget) + vote_count + oh7 + adv + action + drama + lang + log(revenue)*log(budget), data=movies.new)
tidy(int.lm)

#RR
movies.ridge <- glmnet(as.matrix(train[,2:11]), train$pop.log,alpha=0, lambda = movies.ridge.cv$lambda.min, standardize=TRUE)
tidy(movies.ridge)

#Lasso
movies.lasso <- glmnet(as.matrix(train[,2:11]), train$pop.log,alpha=1, lambda = movies.lasso.cv$lambda.min, standardize=TRUE)
tidy(movies.lasso)


ggplot(data = test, aes(x=pop.log, y=ridge.pred)) + 
  geom_point( colour = "yellow")  +
  geom_point(data = test, aes(x=pop.log, y=lasso.pred), colour="blue") +
  geom_point(data = test, aes(x=pop.log, y=mlr.pred), colour="green")+
  xlab ( "Observed Popularity")+
  ylab("Predicted Popularity") + 
  scale_shape_discrete(name  ="Model Type",
                          breaks=c("yellow", "blue", "green"),
                          labels=c("Ridge Regression", "Lasso", "MLR"))
  
  

```

```{r}
plot(test$pop.log, mlr.pred)
```
Introduction: 
In this project, we are interested in determining whether we can predict how "popular" a film will be, given relevant information. Although popularity is inherently difficult to quantify, we relied upon Popularity Scores from The Movie Database (https://www.kaggle.com/tmdb-movie-metadata/data), an index based on online votes, clicks, and 'likes'. To predict such popularity scores, we utilized the variables of budget, revenue, and average critic's vote. All information used in this study was sourced from The Movie Database. The movies included in this database 

Part one
-lasso and ridge regression; use cross-validation to find a value for lambda; compare it to the model from the last part

-have a plot overlaying mlr (from last time), ridge regression, lasso

-choose one variable, and run spline and kernel smoothing methods. in total there are 4 models for each method (1 for each parameter?). plot these all together. which one, and why?

-  


questions:
-what variables do we want to include? pop~revenue, vote avg, budget, genre (group them?)
- how do we group genres? what's the best way to do this / code this. do we have 5 factor variables? and what if some become null (history) -do we filter or include them?
- dates after the year 2007. 
- how to extract language from the list ?
- is it ok to just put in the new variables...
- ask q's about previous assignment - residual plot when to studentize vs. standardize ; mean vs. median ...
- production company - how to make a choice for criteria , deciding if a production company is 'major' or not. 
- dimensionality reduction methods? it would be cool to do ICA or PCA on this data (bc company is probably correlated with budget) etc.
